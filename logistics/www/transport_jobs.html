{% extends "templates/web.html" %}

{% block title %}{{ title or "Transport Jobs" }}{% endblock %}

{% block page_content %}
<div class="transport-jobs-container">
    <!-- Header Section -->
    <div class="portal-header">
        <div class="header-content">
            <div class="logo-section">
                <h1 class="portal-title">üöõ Transport Jobs</h1>
                <p class="portal-subtitle">Track your shipments and deliveries</p>
            </div>
            <div class="customer-info">
                <div class="customer-name">{{ customer_name or "Customer" }}</div>
                <div class="customer-id">Customer ID: {{ customer_id or "N/A" }}</div>
                <button class="refresh-btn" id="refresh-data">üîÑ Refresh</button>
            </div>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-number">{{ total_jobs or 0 }}</div>
            <div class="stat-label">Total Jobs</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="active-jobs">0</div>
            <div class="stat-label">Active Jobs</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completed-jobs">0</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>

    <!-- Map Section -->
    {% if show_vehicle_tracking %}
    <div class="map-section">
        <div class="section-header">
            <h2>üìç Live Vehicle Tracking</h2>
            <div class="map-controls">
                <button class="btn btn-sm btn-primary" id="center-map">Center Map</button>
                <button class="btn btn-sm btn-secondary" id="toggle-tracking">Toggle Tracking</button>
            </div>
        </div>
        <div id="transport-map" class="map-container"></div>
    </div>
    {% endif %}

    <!-- Jobs List Section -->
    <div class="jobs-section">
        <div class="section-header">
            <h2>üìã Your Transport Jobs</h2>
            <div class="filter-controls">
                <select id="status-filter" class="form-control">
                    <option value="">All Status</option>
                    <option value="Draft">Draft</option>
                    <option value="Started">Started</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
        </div>
        
        <div class="jobs-list" id="jobs-list">
            {% if jobs %}
                {% for job in jobs %}
                <div class="job-card" data-status="{{ job.status }}">
                    <div class="job-header">
                        <div class="job-id">Job #{{ job.name }}</div>
                        <div class="job-status status-{{ job.status.lower() }}">{{ job.status }}</div>
                    </div>
                    <div class="job-details">
                        <div class="job-date">üìÖ {{ job.booking_date or "N/A" }}</div>
                        <div class="job-vehicle">üöõ {{ job.vehicle_type or "N/A" }}</div>
                        {% if job.sales_invoice %}
                        <div class="job-invoice">üßæ Invoice: {{ job.sales_invoice }}</div>
                        {% endif %}
                    </div>
                    {% if job.legs %}
                    <div class="job-legs">
                        <h4>Route Legs:</h4>
                        {% for leg in job.legs %}
                        <div class="leg-item">
                            <div class="leg-addresses">
                                <div class="pickup">üìç Pickup: {{ leg.pick_address or "N/A" }}</div>
                                <div class="dropoff">üéØ Dropoff: {{ leg.drop_address or "N/A" }}</div>
                            </div>
                            <div class="leg-status status-{{ leg.status.lower() }}">{{ leg.status }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="no-jobs">
                    <div class="no-jobs-icon">üì≠</div>
                    <h3>No Transport Jobs Found</h3>
                    <p>You don't have any transport jobs yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Transport Jobs Portal Styles */
.transport-jobs-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.portal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.portal-title {
    font-size: 2.5rem;
    margin: 0;
    font-weight: 700;
}

.portal-subtitle {
    font-size: 1.1rem;
    margin: 10px 0 0 0;
    opacity: 0.9;
}

.customer-info {
    text-align: right;
}

.customer-name {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 5px;
}

.customer-id {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 15px;
}

.refresh-btn {
    background: rgba(255,255,255,0.2);
    border: 2px solid rgba(255,255,255,0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
}

.stats-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 10px;
}

.stat-label {
    font-size: 1rem;
    color: #666;
    font-weight: 500;
}

.map-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.section-header h2 {
    margin: 0;
    color: #333;
    font-size: 1.5rem;
}

.map-controls {
    display: flex;
    gap: 10px;
}

.map-container {
    height: 400px;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid #e0e0e0;
}

.jobs-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.filter-controls {
    display: flex;
    gap: 15px;
    align-items: center;
}

.jobs-list {
    margin-top: 20px;
}

.job-card {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.job-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.job-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.job-id {
    font-weight: 600;
    font-size: 1.1rem;
    color: #333;
}

.job-status {
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-draft { background: #ffc107; color: #000; }
.status-started { background: #17a2b8; color: white; }
.status-completed { background: #28a745; color: white; }

.job-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.job-legs {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
}

.job-legs h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1rem;
}

.leg-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid #e0e0e0;
}

.leg-addresses {
    flex: 1;
}

.pickup, .dropoff {
    font-size: 0.9rem;
    margin: 2px 0;
}

.pickup { color: #28a745; }
.dropoff { color: #dc3545; }

.leg-status {
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}

.no-jobs {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.no-jobs-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.no-jobs h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.form-control {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .customer-info {
        text-align: center;
    }
    
    .stats-section {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .job-details {
        grid-template-columns: 1fr;
    }
    
    .leg-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
</style>

<script>
// Include Leaflet CSS and JS
document.head.insertAdjacentHTML('beforeend', 
    '<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />'
);
document.head.insertAdjacentHTML('beforeend', 
    '<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></s' + 'cript>'
);

class TransportJobsPortal {
    constructor() {
        this.map = null;
        this.markers = [];
        this.jobs = {{ jobs | tojson }};
        this.init();
    }

    async init() {
        console.log('üöÄ Initializing transport jobs portal...');
        try {
            await this.initializeMap();
            this.setupEventListeners();
            this.updateStats();
            console.log('‚úÖ Portal initialization complete!');
        } catch (error) {
            console.error('‚ùå Error initializing portal:', error);
            this.showError('Failed to initialize portal');
        }
    }

    async initializeMap() {
        // Get map renderer from transport settings
        const mapRenderer = '{{ map_renderer or "OpenStreetMap" }}'.toLowerCase();
        
        // Initialize map based on renderer (same as run sheet)
        if (mapRenderer === 'google maps') {
            await this.initializeGoogleMap();
        } else if (mapRenderer === 'mapbox') {
            await this.initializeMapboxMap();
        } else if (mapRenderer === 'maplibre') {
            await this.initializeMapLibreMap();
        } else {
            await this.initializeOpenStreetMap();
        }

        // Add initial markers for all vehicles
        this.updateMap();
    }

    async initializeOpenStreetMap() {
        // Initialize OpenStreetMap
        this.map = L.map('transport-map').setView([0, 0], 2);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(this.map);
    }

    async initializeGoogleMap() {
        // Google Maps initialization would go here
        console.log('Google Maps initialization not implemented yet');
    }

    async initializeMapboxMap() {
        // Mapbox initialization would go here
        console.log('Mapbox initialization not implemented yet');
    }

    async initializeMapLibreMap() {
        // MapLibre initialization would go here
        console.log('MapLibre initialization not implemented yet');
    }

    updateMap() {
        if (!this.map) return;
        
        // Clear existing markers
        this.markers.forEach(marker => this.map.removeLayer(marker));
        this.markers = [];
        
        // Add markers for jobs with locations
        this.jobs.forEach(job => {
            if (job.legs) {
                job.legs.forEach(leg => {
                    if (leg.pick_address || leg.drop_address) {
                        // Add markers for pickup and dropoff locations
                        // This would need actual coordinate data
                    }
                });
            }
        });
    }

    setupEventListeners() {
        // Refresh button
        document.getElementById('refresh-data')?.addEventListener('click', () => {
            location.reload();
        });

        // Status filter
        document.getElementById('status-filter')?.addEventListener('change', (e) => {
            this.filterJobsByStatus(e.target.value);
        });

        // Map controls
        document.getElementById('center-map')?.addEventListener('click', () => {
            if (this.map) {
                this.map.setView([0, 0], 2);
            }
        });
    }

    filterJobsByStatus(status) {
        const jobCards = document.querySelectorAll('.job-card');
        jobCards.forEach(card => {
            if (!status || card.dataset.status === status) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    updateStats() {
        const activeJobs = this.jobs.filter(job => job.status === 'Started').length;
        const completedJobs = this.jobs.filter(job => job.status === 'Completed').length;
        
        document.getElementById('active-jobs').textContent = activeJobs;
        document.getElementById('completed-jobs').textContent = completedJobs;
    }

    showError(message) {
        console.error(message);
        // You could show a user-friendly error message here
    }
}

// Initialize portal when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new TransportJobsPortal();
});
</script>
{% endblock %}
