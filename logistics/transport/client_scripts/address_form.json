{
  "name": "Address Map Script",
  "owner": "Administrator",
  "creation": "2025-12-16 13:34:03.154181",
  "modified": "2025-12-17 12:10:55.239630",
  "modified_by": "Administrator",
  "docstatus": 0,
  "idx": 0,
  "dt": "Address",
  "view": "Form",
  "module": "Transport",
  "enabled": 1,
  "script": "// Copyright (c) 2025, www.agilasoft.com and contributors\n// Address Form Script - Map Integration\n// Version: 2.6 - Removed type restriction for default Google Maps search (shows all places including establishments)\n\nconsole.log('=== Address map script file loaded ===');\nconsole.log('=== Version 2.2 - Clean Google Maps Implementation ===');\n\n// ============================================================================\n// Google Maps API Error Handling\n// ============================================================================\n\nwindow._google_maps_auth_failed = false;\nwindow._google_maps_api_loaded = false;\n\nwindow.gm_authFailure = function() {\n    console.error('Address map: Google Maps API authentication failed - API key is invalid or restricted');\n    window._google_maps_auth_failed = true;\n    \n    var currentDomain = window.location.hostname;\n    var domainPattern = currentDomain.indexOf('.') > 0 ? currentDomain.split('.').slice(-2).join('.') : currentDomain;\n    \n    var containers = document.querySelectorAll('[id*=\"address_map_container\"]');\n    containers.forEach(function(container) {\n        if (container && !container.querySelector('.google-maps-error')) {\n            container.innerHTML = '<div class=\"google-maps-error\" style=\"padding: 20px; text-align: center; color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin: 10px 0;\"><strong>\u26a0\ufe0f Google Maps API Authentication Failed</strong><br><small style=\"display: block; margin-top: 10px; text-align: left;\">The API key is invalid, restricted, or billing is not enabled.<br><br><strong>Check in Google Cloud Console:</strong><br>1. Go to <a href=\"https://console.cloud.google.com/apis/credentials\" target=\"_blank\">APIs & Services > Credentials</a><br>2. Click your API key<br>3. Under \"API restrictions\", ensure \"Maps JavaScript API\" and \"Places API\" are enabled<br>4. Under \"Application restrictions\", if set to \"HTTP referrers\", add:<br>&nbsp;&nbsp;\u2022 <code>https://' + currentDomain + '/*</code><br>&nbsp;&nbsp;\u2022 <code>https://*.' + domainPattern + '/*</code><br>5. <strong>Verify billing is enabled</strong> for your Google Cloud project<br><br><strong>Current domain:</strong> <code>' + currentDomain + '</code></small></div>';\n        }\n    });\n};\n\nwindow._handleGoogleMapsError = function(error) {\n    console.error('Address map: Google Maps error:', error);\n    if (error && error.message) {\n        if (error.message.indexOf('InvalidKey') >= 0 || error.message.indexOf('InvalidKeyMapError') >= 0) {\n            if (window.gm_authFailure) {\n                window.gm_authFailure();\n            }\n        }\n    }\n};\n\nwindow.addEventListener('error', function(event) {\n    if (event.message && (\n        event.message.indexOf('InvalidKey') >= 0 || \n        event.message.indexOf('Google Maps') >= 0 ||\n        (event.filename && event.filename.indexOf('maps.googleapis.com') >= 0)\n    )) {\n        console.error('Address map: Detected Google Maps API error:', event.message);\n        window._google_maps_auth_failed = true;\n        if (window.gm_authFailure) {\n            window.gm_authFailure();\n        }\n    }\n}, true);\n\n// ============================================================================\n// Main Initialization\n// ============================================================================\n\n(function() {\n    function initAddressMap() {\n        if (typeof frappe === 'undefined' || !frappe.ui || !frappe.ui.form) {\n            console.log('Address map: Waiting for Frappe UI...');\n            setTimeout(initAddressMap, 100);\n            return;\n        }\n        \n        console.log('Address map: Frappe UI available, registering form handler');\n        \n        frappe.ui.form.on('Address', {\n            setup: function(frm) {\n                console.log('Address form setup - Map script loaded');\n            },\n            \n            onload: function(frm) {\n                console.log('Address form onload');\n            },\n            \n            refresh: function(frm) {\n                console.log('Address form refresh - Initializing map');\n                var attempts = 0;\n                var maxAttempts = 10;\n                \n                var tryInitialize = function() {\n                    attempts++;\n                    console.log('Address map: Attempt ' + attempts + ' to initialize');\n                    var mapField = frm.get_field('custom_address_map');\n                    \n                    if (mapField && mapField.$wrapper && mapField.$wrapper.length > 0) {\n                        console.log('Address map: Field found, initializing...');\n                        initializeAddressMapContent(frm);\n                    } else if (attempts < maxAttempts) {\n                        console.log('Address map: Field not ready, retrying in ' + (attempts * 300) + 'ms...');\n                        setTimeout(tryInitialize, attempts * 300);\n                    } else {\n                        console.error('Address map: Field not found after ' + maxAttempts + ' attempts');\n                    }\n                };\n                \n                setTimeout(tryInitialize, 500);\n            },\n            \n            custom_latitude: function(frm) {\n                updateMapFromCoordinates(frm);\n            },\n            \n            custom_longitude: function(frm) {\n                updateMapFromCoordinates(frm);\n            }\n        });\n    }\n    \n    initAddressMap();\n})();\n\n// ============================================================================\n// Map Initialization Functions\n// ============================================================================\n\nasync function initializeAddressMapContent(frm) {\n    console.log('Initializing address map for:', frm.doc.name || 'new record');\n    \n    var mapField = frm.get_field('custom_address_map');\n    if (!mapField || !mapField.$wrapper) {\n        console.error('Address map: Field or wrapper not found');\n        return;\n    }\n    \n    var $wrapper = mapField.$wrapper;\n    var mapContainerId = 'address_map_container_' + (frm.doc.name || 'new').replace(/[^a-zA-Z0-9]/g, '_');\n    var searchInputId = 'address_search_input_' + (frm.doc.name || 'new').replace(/[^a-zA-Z0-9]/g, '_');\n    var mapHTML = '<div style=\"margin-bottom: 10px;\"><input type=\"text\" id=\"' + searchInputId + '\" placeholder=\"Search for an address...\" style=\"width: 100%; padding: 8px 12px; border: 1px solid #d1d8dd; border-radius: 4px; font-size: 14px; box-sizing: border-box;\"/></div><div id=\"' + mapContainerId + '\" style=\"width: 100%; height: 400px; border: 1px solid #d1d8dd; border-radius: 4px; margin-top: 10px; background: #f8f9fa;\"></div><div style=\"margin-top: 10px; font-size: 12px; color: #6c757d;\"><i class=\"fa fa-info-circle\"></i> Search for an address or click on the map to set coordinates</div>';\n    \n    try {\n        var $target = $wrapper.find('.html-content, .control-value, .control-input-wrapper').first();\n        if (!$target || $target.length === 0) {\n            $target = $wrapper.children().first();\n            if ($target.length === 0) {\n                $target = $wrapper;\n            }\n        }\n        $target.html(mapHTML);\n        $wrapper.html(mapHTML);\n    } catch (error) {\n        console.error('Address map: Error setting HTML:', error);\n    }\n    \n    setTimeout(function() {\n        var container = document.getElementById(mapContainerId);\n        if (container) {\n            console.log('Address map: Container verified in DOM!');\n        }\n    }, 500);\n    \n    var mapRenderer = 'OpenStreetMap';\n    var tilesUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';\n    var tilesAttr = '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors';\n    var googleApiKey = null;\n    var mapboxApiKey = null;\n    \n    try {\n        var settings = await frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'Transport Settings',\n                name: 'Transport Settings'\n            }\n        });\n        \n        if (settings.message) {\n            mapRenderer = settings.message.map_renderer || 'OpenStreetMap';\n            tilesUrl = settings.message.routing_tiles_url || tilesUrl;\n            tilesAttr = settings.message.routing_tiles_attr || tilesAttr;\n            \n            // Get Google Maps API key using proper endpoint (decrypts Password field)\n            try {\n                var apiKeyResponse = await frappe.call({\n                    method: 'logistics.transport.api.address_map_api.get_google_maps_api_key'\n                });\n                if (apiKeyResponse.message && apiKeyResponse.message.api_key) {\n                    googleApiKey = apiKeyResponse.message.api_key;\n                }\n                console.log('Address map: Google API Key retrieved:', googleApiKey ? 'Present' : 'Missing');\n            } catch (error) {\n                console.error('Address map: Error getting API key:', error);\n            }\n            \n            mapboxApiKey = settings.message.routing_mapbox_api_key;\n            console.log('Address map: Map Renderer:', mapRenderer);\n            console.log('Address map: Google API Key present:', !!googleApiKey);\n        }\n    } catch (e) {\n        console.error('Address map: Error getting Transport Settings:', e);\n    }\n    \n    var lat = parseFloat(frm.doc.custom_latitude);\n    var lon = parseFloat(frm.doc.custom_longitude);\n    \n    initializeMapRenderer(frm, mapContainerId, lat, lon, mapRenderer, tilesUrl, tilesAttr, googleApiKey, mapboxApiKey);\n}\n\nasync function initializeMapRenderer(frm, mapContainerId, lat, lon, mapRenderer, tilesUrl, tilesAttr, googleApiKey, mapboxApiKey) {\n    await new Promise(function(resolve) {\n        setTimeout(resolve, 500);\n    });\n    \n    var container = document.getElementById(mapContainerId);\n    if (!container) {\n        var allContainers = document.querySelectorAll('[id*=\"address_map\"]');\n        if (allContainers.length > 0) {\n            container = allContainers[0];\n            mapContainerId = container.id;\n        }\n    }\n    \n    if (!container) {\n        console.error('Address map: Container not found');\n        return;\n    }\n    \n    console.log('Address map: Container found, initializing map with renderer:', mapRenderer);\n    var rendererLower = (mapRenderer || '').toLowerCase().trim();\n    \n    if (rendererLower === 'google maps' || rendererLower === 'googlemaps' || rendererLower.indexOf('google') >= 0) {\n        console.log('Address map: Using Google Maps renderer');\n        await initializeGoogleMap(frm, mapContainerId, lat, lon, googleApiKey);\n    } else if (rendererLower === 'mapbox') {\n        await initializeMapboxMap(frm, mapContainerId, lat, lon, mapboxApiKey);\n    } else if (rendererLower === 'maplibre') {\n        await initializeMapLibreMap(frm, mapContainerId, lat, lon, tilesUrl, tilesAttr);\n    } else {\n        await initializeOpenStreetMap(frm, mapContainerId, lat, lon, tilesUrl, tilesAttr);\n    }\n}\n\nasync function initializeGoogleMap(frm, mapContainerId, lat, lon, apiKey) {\n    console.log('Address map: Initializing Google Maps - V2.2');\n    \n    if (!apiKey || apiKey.length < 10) {\n        console.error('Address map: Google Maps API key not configured');\n        var container = document.getElementById(mapContainerId);\n        if (container) {\n            container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;\"><strong>\u26a0\ufe0f Google Maps API Key Not Configured</strong><br><small style=\"display: block; margin-top: 10px;\">Please set the Google API Key in Transport Settings.</small></div>';\n        }\n        return;\n    }\n    \n    // Load Google Maps API if not already loaded\n    if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {\n        console.log('Address map: Loading Google Maps API...');\n        try {\n            await loadGoogleMapsAPI(apiKey);\n        } catch (error) {\n            console.error('Address map: Failed to load Google Maps API:', error);\n            var container = document.getElementById(mapContainerId);\n            if (container) {\n                container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;\"><strong>\u26a0\ufe0f Google Maps API Failed to Load</strong><br><small style=\"display: block; margin-top: 10px;\">Please check your Google Cloud Console configuration.</small></div>';\n            }\n            return;\n        }\n    }\n    \n    // Wait for API to be fully ready\n    var retries = 0;\n    while ((typeof google === 'undefined' || !google.maps || !google.maps.Map) && retries < 50) {\n        await new Promise(function(resolve) {\n            setTimeout(resolve, 100);\n        });\n        retries++;\n    }\n    \n    // Final check\n    if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {\n        console.error('Address map: Google Maps API failed to load - Map constructor not available');\n        var container = document.getElementById(mapContainerId);\n        if (container) {\n            container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;\"><strong>\u26a0\ufe0f Google Maps API Failed to Load</strong><br><small style=\"display: block; margin-top: 10px;\">The Google Maps API did not load properly. Please check your browser console for errors.</small></div>';\n        }\n        return;\n    }\n    \n    console.log('Address map: Google Maps API is ready, Map constructor available');\n    \n    try {\n        var container = document.getElementById(mapContainerId);\n        if (!container) {\n            console.error('Address map: Container not found for Google Maps');\n            return;\n        }\n        \n        var defaultLat = lat && !isNaN(lat) ? lat : 0;\n        var defaultLon = lon && !isNaN(lon) ? lon : 0;\n        var centerLat = defaultLat || 0;\n        var centerLon = defaultLon || 0;\n        var zoom = (lat && lon && !isNaN(lat) && !isNaN(lon)) ? 15 : 2;\n        \n        var map = new google.maps.Map(container, {\n            center: { lat: centerLat, lng: centerLon },\n            zoom: zoom,\n            mapTypeId: 'roadmap'\n        });\n        \n        google.maps.event.addListenerOnce(map, 'tilesloaded', function() {\n            console.log('Address map: Google Maps tiles loaded successfully');\n        });\n        \n        setTimeout(function() {\n            try {\n                var center = map.getCenter();\n                if (!center) {\n                    throw new Error('Map center not available');\n                }\n            } catch (error) {\n                console.error('Address map: Google Maps error detected:', error);\n            }\n        }, 3000);\n        \n        var marker = null;\n        if (lat && lon && !isNaN(lat) && !isNaN(lon)) {\n            marker = new google.maps.Marker({\n                position: { lat: lat, lng: lon },\n                map: map,\n                draggable: true,\n                title: 'Address Location'\n            });\n            \n            var infoWindow = new google.maps.InfoWindow({\n                content: '<div><strong>Address Location</strong><br>Latitude: ' + lat.toFixed(6) + '<br>Longitude: ' + lon.toFixed(6) + '<br><small>Drag marker to update coordinates</small></div>'\n            });\n            \n            marker.addListener('click', function() {\n                infoWindow.open(map, marker);\n            });\n            \n            infoWindow.open(map, marker);\n            \n            marker.addListener('dragend', function(e) {\n                var position = marker.getPosition();\n                frm.set_value('custom_latitude', position.lat());\n                frm.set_value('custom_longitude', position.lng());\n                infoWindow.setContent('<div><strong>Address Location</strong><br>Latitude: ' + position.lat().toFixed(6) + '<br>Longitude: ' + position.lng().toFixed(6) + '<br><small>Drag marker to update coordinates</small></div>');\n            });\n        }\n        \n        map.addListener('click', function(e) {\n            var clickedLat = e.latLng.lat();\n            var clickedLon = e.latLng.lng();\n            frm.set_value('custom_latitude', clickedLat);\n            frm.set_value('custom_longitude', clickedLon);\n            \n            if (marker) {\n                marker.setPosition({ lat: clickedLat, lng: clickedLon });\n            } else {\n                marker = new google.maps.Marker({\n                    position: { lat: clickedLat, lng: clickedLon },\n                    map: map,\n                    draggable: true,\n                    title: 'Address Location'\n                });\n                \n                var infoWindow = new google.maps.InfoWindow({\n                    content: '<div><strong>Address Location</strong><br>Latitude: ' + clickedLat.toFixed(6) + '<br>Longitude: ' + clickedLon.toFixed(6) + '<br><small>Drag marker to update coordinates</small></div>'\n                });\n                \n                marker.addListener('click', function() {\n                    infoWindow.open(map, marker);\n                });\n                \n                marker.addListener('dragend', function(e) {\n                    var position = marker.getPosition();\n                    frm.set_value('custom_latitude', position.lat());\n                    frm.set_value('custom_longitude', position.lng());\n                });\n                \n                infoWindow.open(map, marker);\n            }\n        });\n        \n        frm._address_map = map;\n        frm._address_marker = marker;\n        \n        // Initialize Places Autocomplete\n        initializePlacesAutocomplete(frm, map, marker, apiKey);\n        \n        console.log('Address map: Google Maps initialized successfully');\n        \n    } catch (error) {\n        console.error('Address map: Error initializing Google Maps:', error);\n        var container = document.getElementById(mapContainerId);\n        if (container) {\n            container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;\"><strong>\u26a0\ufe0f Error Initializing Google Maps</strong><br><small style=\"display: block; margin-top: 10px;\">' + (error.message || 'Unknown error') + '</small></div>';\n        }\n    }\n}\n\nfunction loadGoogleMapsAPI(apiKey) {\n    return new Promise(function(resolve, reject) {\n        // Check if already loaded\n        if (typeof google !== 'undefined' && google.maps && google.maps.Map) {\n            console.log('Address map: Google Maps API already loaded');\n            resolve();\n            return;\n        }\n        \n        // Check if already loading\n        if (window._google_maps_loading) {\n            // Wait for existing load to complete\n            var checkInterval = setInterval(function() {\n                if (typeof google !== 'undefined' && google.maps && google.maps.Map) {\n                    clearInterval(checkInterval);\n                    resolve();\n                } else if (!window._google_maps_loading) {\n                    clearInterval(checkInterval);\n                    reject(new Error('Google Maps API failed to load'));\n                }\n            }, 100);\n            return;\n        }\n        \n        window._google_maps_loading = true;\n        \n        // Create callback function\n        window._googleMapsInitCallback = function() {\n            console.log('Address map: Google Maps API loaded and ready');\n            window._google_maps_api_loaded = true;\n            window._google_maps_loading = false;\n            delete window._googleMapsInitCallback;\n            resolve();\n        };\n        \n        var script = document.createElement('script');\n        script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&libraries=places&callback=_googleMapsInitCallback';\n        script.async = true;\n        script.defer = true;\n        script.onerror = function() {\n            console.error('Address map: Failed to load Google Maps API');\n            window._google_maps_loading = false;\n            delete window._googleMapsInitCallback;\n            reject(new Error('Failed to load Google Maps API'));\n        };\n        document.head.appendChild(script);\n    });\n}\n\nfunction initializeOpenStreetMap(frm, mapContainerId, lat, lon, tilesUrl, tilesAttr) {\n    console.log('Address map: Initializing OpenStreetMap');\n    // OpenStreetMap implementation would go here\n    var container = document.getElementById(mapContainerId);\n    if (container) {\n        container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #6c757d;\">OpenStreetMap renderer not yet implemented</div>';\n    }\n}\n\nfunction initializeMapboxMap(frm, mapContainerId, lat, lon, apiKey) {\n    console.log('Address map: Initializing Mapbox');\n    // Mapbox implementation would go here\n    var container = document.getElementById(mapContainerId);\n    if (container) {\n        container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #6c757d;\">Mapbox renderer not yet implemented</div>';\n    }\n}\n\nfunction initializeMapLibreMap(frm, mapContainerId, lat, lon, tilesUrl, tilesAttr) {\n    console.log('Address map: Initializing MapLibre');\n    // MapLibre implementation would go here\n    var container = document.getElementById(mapContainerId);\n    if (container) {\n        container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #6c757d;\">MapLibre renderer not yet implemented</div>';\n    }\n}\n\n\n// ============================================================================\n// Google Places Autocomplete Functions\n// ============================================================================\n\nfunction initializePlacesAutocomplete(frm, map, marker, apiKey) {\n    // Wait for Places library to be available\n    if (typeof google === 'undefined' || !google.maps || !google.maps.places) {\n        console.log('Address map: Waiting for Places library...');\n        setTimeout(function() {\n            initializePlacesAutocomplete(frm, map, marker, apiKey);\n        }, 100);\n        return;\n    }\n    \n    var searchInputId = 'address_search_input_' + (frm.doc.name || 'new').replace(/[^a-zA-Z0-9]/g, '_');\n    var searchInput = document.getElementById(searchInputId);\n    \n    if (!searchInput) {\n        console.error('Address map: Search input not found');\n        return;\n    }\n    \n    console.log('Address map: Initializing Places Autocomplete');\n    \n    // Create Autocomplete - no type restriction to show all places like Google Maps app\n    var autocomplete = new google.maps.places.Autocomplete(searchInput, {\n        fields: ['address_components', 'geometry', 'formatted_address', 'name', 'place_id']\n    });\n    \n    // Bind autocomplete to map bounds\n    autocomplete.bindTo('bounds', map);\n    \n    // When a place is selected\n    autocomplete.addListener('place_changed', function() {\n        var place = autocomplete.getPlace();\n        \n        if (!place.geometry || !place.geometry.location) {\n            console.warn('Address map: No geometry found for selected place');\n            return;\n        }\n        \n        console.log('Address map: Place selected:', place.formatted_address);\n        \n        // Update map center and zoom\n        map.setCenter(place.geometry.location);\n        if (place.geometry.viewport) {\n            map.fitBounds(place.geometry.viewport);\n        } else {\n            map.setZoom(17);\n        }\n        \n        // Update or create marker\n        var position = place.geometry.location;\n        var lat = position.lat();\n        var lng = position.lng();\n        \n        if (marker) {\n            marker.setPosition(position);\n        } else {\n            marker = new google.maps.Marker({\n                position: position,\n                map: map,\n                draggable: true,\n                title: 'Address Location'\n            });\n            \n            var infoWindow = new google.maps.InfoWindow({\n                content: '<div><strong>Address Location</strong><br>Latitude: ' + lat.toFixed(6) + '<br>Longitude: ' + lng.toFixed(6) + '<br><small>Drag marker to update coordinates</small></div>'\n            });\n            \n            marker.addListener('click', function() {\n                infoWindow.open(map, marker);\n            });\n            \n            marker.addListener('dragend', function(e) {\n                var pos = marker.getPosition();\n                frm.set_value('custom_latitude', pos.lat());\n                frm.set_value('custom_longitude', pos.lng());\n                infoWindow.setContent('<div><strong>Address Location</strong><br>Latitude: ' + pos.lat().toFixed(6) + '<br>Longitude: ' + pos.lng().toFixed(6) + '<br><small>Drag marker to update coordinates</small></div>');\n            });\n            \n            frm._address_marker = marker;\n        }\n        \n        // Update coordinates\n        frm.set_value('custom_latitude', lat);\n        frm.set_value('custom_longitude', lng);\n        \n        // Parse address components and populate form fields\n        var addressComponents = place.address_components || [];\n        var addressData = {\n            address_line1: '',\n            address_line2: '',\n            city: '',\n            county: '',\n            state: '',\n            country: '',\n            pincode: ''\n        };\n        \n        // Parse address components\n        for (var i = 0; i < addressComponents.length; i++) {\n            var component = addressComponents[i];\n            var types = component.types;\n            \n            if (types.indexOf('street_number') >= 0) {\n                addressData.address_line1 = component.long_name;\n            } else if (types.indexOf('route') >= 0) {\n                if (addressData.address_line1) {\n                    addressData.address_line1 += ' ' + component.long_name;\n                } else {\n                    addressData.address_line1 = component.long_name;\n                }\n            } else if (types.indexOf('subpremise') >= 0 || types.indexOf('premise') >= 0) {\n                addressData.address_line2 = component.long_name;\n            } else if (types.indexOf('locality') >= 0 || types.indexOf('sublocality') >= 0) {\n                if (!addressData.city) {\n                    addressData.city = component.long_name;\n                }\n            } else if (types.indexOf('administrative_area_level_2') >= 0) {\n                addressData.county = component.long_name;\n            } else if (types.indexOf('administrative_area_level_1') >= 0) {\n                addressData.state = component.long_name;\n            } else if (types.indexOf('country') >= 0) {\n                addressData.country = component.long_name;\n            } else if (types.indexOf('postal_code') >= 0) {\n                addressData.pincode = component.long_name;\n            }\n        }\n        \n        // If address_line1 is empty, use place name or formatted_address\n        if (!addressData.address_line1) {\n            if (place.name) {\n                addressData.address_line1 = place.name;\n            } else if (place.formatted_address) {\n                var parts = place.formatted_address.split(',');\n                if (parts.length > 0) {\n                    addressData.address_line1 = parts[0].trim();\n                }\n            }\n        }\n        \n        // Update form fields\n        if (addressData.address_line1) {\n            frm.set_value('address_line1', addressData.address_line1);\n        }\n        if (addressData.address_line2) {\n            frm.set_value('address_line2', addressData.address_line2);\n        }\n        if (addressData.city) {\n            frm.set_value('city', addressData.city);\n        }\n        if (addressData.county) {\n            frm.set_value('county', addressData.county);\n        }\n        if (addressData.state) {\n            frm.set_value('state', addressData.state);\n        }\n        if (addressData.country) {\n            frm.set_value('country', addressData.country);\n        }\n        if (addressData.pincode) {\n            frm.set_value('pincode', addressData.pincode);\n        }\n        \n        console.log('Address map: Address fields populated from Places API');\n    });\n    \n    frm._address_autocomplete = autocomplete;\n}\n\nfunction updateMapFromCoordinates(frm) {\n    if (frm._address_map && frm._address_marker) {\n        var lat = parseFloat(frm.doc.custom_latitude);\n        var lon = parseFloat(frm.doc.custom_longitude);\n        \n        if (lat && lon && !isNaN(lat) && !isNaN(lon)) {\n            var position = { lat: lat, lng: lon };\n            frm._address_map.setCenter(position);\n            frm._address_marker.setPosition(position);\n        }\n    }\n}\n",
  "doctype": "Client Script"
}